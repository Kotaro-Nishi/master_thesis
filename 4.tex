\documentclass[a4paper,11pt,uplatex]{jsbook}
\input{0_preamble}

% 数式
%\usepackage{amsmath,amsfonts}
%\usepackage{bm}
%\usepackage{physics}
% 画像
%\usepackage[dvipdfmx]{graphicx}
%\usepackage[dvipdfmx,colorlinks=true,linkcolor=blue]{hyperref}
%\usepackage{pxjahyper}

\begin{document}

\chapter{データ解析と結果}
この章ではデータ解析の手順と結果について述べる。

単独アンジュレータのデータおよびエネルギー測定用の2台のアンジュレータのデータの2つのデータセットがある。
画像処理までの手順は共通であるのでまずは画像処理について述べる。
続いて単独アンジュレータのデータの解析結果を述べる。
最後に2台のアンジュレータのデータの解析結果について述べる。\\
なおエネルギー測定のデータセットは以下のように構成されている。
\begin{itemize}
  \item 水銀灯の波長較正データ1枚
  \item アンジュレータの位置データ 166個の値
  \item 干渉光の画像データ 166 position $\times$ 4 画像 = 664枚
\end{itemize}
これを反映し、エネルギーデータ解析の手順は以下のようになる。
\begin{enumerate}
  \item 波長較正 波長 - px直線を求める
  \item 画像の統合 664枚-> 166枚の二次元データ
  \item 較正波長でのデータの切り出し 166枚の二次元データ-> 166成分の1次元データ
  \item モデル関数によるフィッティング
\end{enumerate}

\section{画像処理}
\noindent \textbf{\underline{解析}}\par
まず電子ビームを入射していない状態の画像を取得し、これを背景画像とする。露光時間10 秒で10枚の画像を連続で取得し、背景画像とした。\\
各runでは、各ポジションで4枚の画像が取得される。
これらの4枚の画像について、各ピクセルごとに平均値を取り、その値をピクセルの代表値とする。
またピクセルの誤差は4枚のピクセルの標準偏差とする。\\
予想される回折パターンの性質を考えると、隣り合うピクセル同士の発光量の差は周囲の上下左右のピクセルに対して極端に発光量が多いピクセルはノイズであると判断してマスクし、フィッティングの対象に含まない。

\noindent \textbf{\underline{結果}}\par
背景画像の結果を示す。平均してピクセル値が100 程度、標準誤差は5程度となった。

全てのピクセルの平均値と標準偏差の関係を示す。

周囲のピクセルと比較した超過値の分布を示す。閾値として今回は40を設定した。超過値が40を超えるピクセルはノイズピクセルとして除去した。
ノイズピクセルと判定されたピクセルの割合は平均して??\%であった。
また、ピクセルが異常を起こし、常にノイズピクセルとして判定される割合は??\%程度だったのに対し、放射線など偶発的にノイズが乗るピクセルは??\%程度であった。

\section{波長較正}
\noindent \textbf{\underline{解析}}\par
水銀灯の404.656 nmおよび407.781 nmの輝線スペクトルをガウシアンでフィットし、ピーク中心の位置を求める。
2本の輝線から、波長 - pxの線形性を仮定し、画像全体の波長 - px直線を求める。
ピークの中心決定精度から波長較正の精度を求める。

\noindent \textbf{\underline{結果}}\par
水銀灯の波長較正で得られた画像の例を示す。

\section{モデル関数によるフィッティング}
\noindent \textbf{\underline{解析}}\par
この節では、単独アンジュレータのデータおよび2台のアンジュレータのデータ両方の解析に用いるモデル関数について述べる。モデル関数は、エネルギーを含む各種パラメータとアンジュレータの位置を入力として、回折パターンの形状をカメラのy座標の関数として出力する関数である。
\subsection{1電子放射光関数}
アンジュレータ放射光の振幅は放射角の関数として以下のように計算できることが知られている。
また放射光の位相は球面波を仮定する。

\subsection{フレネル回折}
放射光関数で計算されたスリットにおける光波($U(x)$)から、カメラにおける回折光を計算する。フレネル近似を用いて計算を行う。

\subsubsection{数値計算上の計算手法}
数値計算を実行する上では数値積分の手法では、伝搬後のN次元の配列が伝搬前のN次元配列全ての積分を用いて計算されるため計算量は$\text{N}^2$となる。
このような計算コストの高い計算を避けるために、高速フーリエ変換を用いた計算が一般に用いられている。
式(\ref{レイリーゾンマーフェルト近似})を再度$x,y,x_0,y_0$で書き直すと
\begin{eqnarray}
  \text{U}(x_0,y_0) \sim \frac{1}{2i\lambda zs}\int_S \text{U}(x,y) \exp( ik \sqrt{z^2 + (x-x_0)^2 + (y-y_0)^2}) dxdy
\end{eqnarray}
これはカーネル関数$f(x,y) = \sqrt{z^2 +x^2 + y^2}$であるような畳み込みの形で書ける。
\begin{eqnarray}
  U(x_0,y_0) \sim (\text{U} * f)(x,y)
\end{eqnarray}
畳み込みはフーリエ変換を用いることで
\begin{eqnarray}
  (U*f)(x,y) = \mathcal{F}^{-1}(\mathcal{F}(U) \times \mathcal{F}(f)) \label{convolution}
\end{eqnarray}
と表せる。ここで$\mathcal{F}$はフーリエ変換を表す。これは以下のように示すことができる。
\begin{eqnarray}
  (U*f)(x) = \int_{-\infty}^{\infty} U(t)f(x-t)dt
\end{eqnarray}
これをフーリエ変換したものは、
\begin{eqnarray}
  \mathcal{F}(U*f)(k) = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} U(t)f(x-t)dt \exp(-ikx)dx
\end{eqnarray}
積分の順序を交換して$x-t = y$とおくと、
\begin{eqnarray}
  \mathcal{F}(U*f)(k) &=& \int_{-\infty}^{\infty} U(t) \exp(-ikt)dt \int_{-\infty}^{\infty} f(y) \exp(-iky)dy\\
  &=& \mathcal{F}(U) \times \mathcal{F}(f)
\end{eqnarray}
したがって\ref{convolution}が示される。

フーリエ変換による計算では、周波数空間のあらわす光波は計算空間と同じ大きさの周期的な光波として表現される。そのため、そのまま逆変換を行うと隣り合う計算空間の光波が干渉してしまう。これを防ぐために、計算空間の端を0で埋め、計算空間を拡大するゼロパディングを行う。

\subsection{電子ビームサイズ}
1電子の放射光であると仮定していた放射光関数は、電子ビームサイズを考慮すると、異なる電子からの放射光関数の重ね合わせとして表現できると考えられる。
y軸方向のビームサイズを$\sigma_y$として、ガウス上の広がりを考慮し、放射光関数を畳みこむ。
これにより1電子放射光関数から得られる回折パターンはぼやける。
\subsection{光学系}
回折格子によって分光された光はレンズによってカメラで収束する。スリットの形状および回折格子はx方向にも幅を持つが、計算時間の都合上y軸方向のみの1次元の計算を行う。
1次元の回折と2次元の回折の結果はほとんど変わらないことが確認されている。
\subsection{パラメータ}
求める関数系は放射光関数と光学系関数からなる。
パラメータの定義を以下に示す。
\begin{table}[h]
\centering
\begin{tabular}{c|c}
  $\gamma$ & 電子ビームエネルギーのローレンツ因子 \\
  $\text{K}$ & アンジュレータのK値 \\
  $\text{z(U2-slit)}$ & 下流アンジュレータ-スリット間の距離 \\
  $\text{z(slit-camera)}$ & スリット-カメラ間の距離 \\
  $\text{w(slit)}$ & スリットの鉛直方向の長さ \\
  $\text{y(beam)}$ & カメラに対するビーム中心のy座標 \\
  $\text{y(slit)}$ & カメラに対するスリット中心のy座標 \\
  $\delta \phi$ & 上流と下流のアンジュレータの位相のずれ\\
\end{tabular}
\end{table}

\subsection{パラメータ較正}
単独アンジュレータのデータを解析し、z(U2- slit),z(slit-camera),w(slit)の最適値を求める。
2台のアンジュレータのデータではこれらのパラメータを固定してフィッティングを行う。ただし系統誤差を見積もるために、パラメータを変化させた場合のフィッティングも行う。\\
また、アンジュレータが下流に移動することによる光量の変化をampl パラメータのd依存性に押し込む。この依存性から、上流アンジュレータと下流アンジュレータの寄与の係数も決定できる。
\section{単独アンジュレータの解析}
\noindent \textbf{\underline{解析}}\par
パラメータ較正を目的とした単独アンジュレータのデータの解析を述べる。
下流アンジュレータのみの磁場によって得られるデータから、放射光関数の位置依存性の情報が抽出できる。
理想的な条件では、アンジュレータが下流に移動すると以下のような変化が見られると考えられる。
\begin{itemize}
  \item アクセプタンスの増加による振幅の上昇
  \item 光学的な位置関係の変化による回折パターンの形状の変化
\end{itemize}

振幅の上昇と回折パターンの形状の変化から、距離のパラメータ z(U2-slit),z(slit-cam),w(slits)の最適値を求めることができる。
z(U2-slit),z(slit-cam),w(slit)を固定してフィッティングを行い、適合度がもっとも良いパラメータの組を最適な値として定義する。

\noindent \textbf{\underline{結果}}\par

\section{統計誤差の見積もり}
統計誤差の見積もりはブートストラップ法によって行う。
ブートストラップ法はデータから復元抽出を行い、その復元抽出データから統計量を計算することで統計量の分布を推定する手法である。
下流アンジュレータの位置に関してランダムに復元抽出を複数回行い、抽出されたデータの集合に対してフィッティングを行う。得られたパラメータの分布から統計誤差を見積もる。
\section{系統誤差の見積もり}
波長依存性と位置依存性による系統誤差が主要な誤差要因と考えられる。
\subsection{波長依存性}
較正波長(404.65 nm)におけるエネルギー測定の結果に加えて、同じモデル関数を用いて異なる波長でのデータからエネルギーを求める。
異なる波長に対するエネルギーの分布から、モデル関数や装置のもつ波長依存性による系統誤差を見積もる。
\subsection{位置依存性}
アンジュレータの位置によるエネルギーの推定値の違いを見積もる。
具体的には、アンジュレータの位置を4つの区間に分割し、各区間でエネルギーを求める。アンジュレータ位置に対する放射光関数の補正がどの程度の影響を持つかを見積もる。

\subsection{平滑化}
画像の平滑化が必要な場合には、波長方向にのみ行う。同様にノイズピクセルをマスクしたうえで平均値と標準偏差を計算し、ピクセルの誤差は標準偏差を計算に用いたピクセル数の平方根で割った値(標準誤差)とする。



\end{document}